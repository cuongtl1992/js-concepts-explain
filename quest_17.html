<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Thread vs Web Worker Performance</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            overflow-x: hidden;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1, h2, h3 {
            color: #333;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .code-container {
            background-color: #282c34;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: white;
            font-family: monospace;
            overflow-x: auto;
        }
        .code {
            line-height: 1.5;
            white-space: pre;
        }
        .tab-container {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #eee;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        .tab:hover:not(.active) {
            background-color: #ddd;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .animation-container {
            display: flex;
            flex-direction: column;
            margin: 20px 0;
        }
        .browser-simulation {
            display: flex;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
        }
        .browser-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            position: relative;
        }
        .browser-section:last-child {
            border-right: none;
        }
        .browser-toolbar {
            height: 30px;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-bottom: 1px solid #ccc;
        }
        .browser-title {
            font-weight: bold;
            font-size: 14px;
        }
        .browser-content {
            flex: 1;
            padding: 15px;
            position: relative;
            overflow: hidden;
        }
        .ui-element {
            background-color: #3498db;
            color: white;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
        }
        .computation-box {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background-color: #e74c3c;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            z-index: 5;
        }
        .worker-box {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background-color: #2ecc71;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            z-index: 5;
        }
        .control-panel {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #2980b9;
        }
        .button.reset {
            background-color: #e74c3c;
        }
        .button.reset:hover {
            background-color: #c0392b;
        }
        .loading-bar-container {
            width: 100%;
            height: 20px;
            background-color: #f1f1f1;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        .loading-bar {
            height: 100%;
            width: 0%;
            background-color: #4CAF50;
            border-radius: 10px;
            transition: width 0.3s;
        }
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
        }
        .metrics-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
        }
        .metrics-item {
            margin: 3px 0;
        }
        .explanation-content {
            line-height: 1.6;
        }
        .code-highlight {
            background-color: rgba(255, 255, 100, 0.3);
            padding: 2px;
            border-radius: 3px;
        }
        .worker-message {
            background-color: #f8f9fa;
            border-left: 4px solid #2ecc71;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
        }
        .thread-diagram {
            display: flex;
            margin: 20px 0;
        }
        .thread {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 0 10px;
        }
        .main-thread {
            background-color: #ffeeee;
        }
        .worker-thread {
            background-color: #eeffee;
        }
        .thread-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .thread-task {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .ui-task {
            background-color: #bbdefb;
        }
        .computation-task {
            background-color: #ffcdd2;
        }
        .worker-task {
            background-color: #c8e6c9;
        }
        .thread-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Heavy Computation: Main Thread vs Web Worker</h1>
        
        <div class="code-container">
            <div class="code">// Heavy computation on the main thread (problematic)
for (let i = 0; i < 1e7; i++) {
    // thực hiện các tính toán nặng
}
console.log("Xử lý hoàn tất");</div>
        </div>
        
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('demo')">Demonstration</div>
            <div class="tab" onclick="switchTab('explanation')">Explanation</div>
            <div class="tab" onclick="switchTab('solution')">Solution with Web Workers</div>
        </div>
        
        <div id="demo-section" class="content-section active">
            <div class="animation-container">
                <div class="browser-simulation">
                    <div class="browser-section">
                        <div class="browser-toolbar">
                            <div class="browser-title">Main Thread Application</div>
                        </div>
                        <div class="browser-content" id="main-thread-content">
                            <div class="ui-element" onclick="animateClick(this)">Click Me</div>
                            <div class="ui-element" onclick="animateClick(this)">Interactive Button</div>
                            <div class="ui-element" onclick="animateClick(this)">Another Button</div>
                            <div class="loading-bar-container">
                                <div class="loading-bar" id="main-loading-bar"></div>
                            </div>
                            <div id="main-computation-box" class="computation-box" style="display: none;">
                                Computing...
                            </div>
                            <div id="main-overlay" class="overlay">UI BLOCKED</div>
                            <div class="metrics-panel" id="main-metrics">
                                <div class="metrics-item">UI Responsiveness: <span id="main-responsiveness">100%</span></div>
                                <div class="metrics-item">Tasks Completed: <span id="main-tasks">0</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="browser-section">
                        <div class="browser-toolbar">
                            <div class="browser-title">Web Worker Application</div>
                        </div>
                        <div class="browser-content" id="worker-thread-content">
                            <div class="ui-element" onclick="animateClick(this)">Click Me</div>
                            <div class="ui-element" onclick="animateClick(this)">Interactive Button</div>
                            <div class="ui-element" onclick="animateClick(this)">Another Button</div>
                            <div class="loading-bar-container">
                                <div class="loading-bar" id="worker-loading-bar"></div>
                            </div>
                            <div id="worker-computation-box" class="worker-box" style="display: none;">
                                Worker Computing...
                            </div>
                            <div class="metrics-panel" id="worker-metrics">
                                <div class="metrics-item">UI Responsiveness: <span id="worker-responsiveness">100%</span></div>
                                <div class="metrics-item">Tasks Completed: <span id="worker-tasks">0</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-panel">
                    <button class="button" id="main-start-btn" onclick="startMainThreadComputation()">Start Main Thread Computation</button>
                    <button class="button" id="worker-start-btn" onclick="startWorkerComputation()">Start Worker Computation</button>
                    <button class="button" id="interact-btn" onclick="testInteraction()">Test UI Interactivity</button>
                    <button class="button reset" onclick="resetSimulation()">Reset</button>
                </div>
            </div>
        </div>
        
        <div id="explanation-section" class="content-section">
            <div class="explanation-content">
                <h2>The Problem: UI Blocking</h2>
                <p>JavaScript runs on a single thread in the browser called the "main thread". This thread is responsible for:</p>
                <ul>
                    <li>Parsing and executing JavaScript</li>
                    <li>Handling user events (clicks, scrolls, etc.)</li>
                    <li>Performing DOM updates and rendering</li>
                    <li>Processing all computations in your code</li>
                </ul>
                
                <p>When you run heavy computations like:</p>
                <div class="code-container">
                    <div class="code">for (let i = 0; i < 1e7; i++) {
    // Heavy calculations
}</div>
                </div>
                
                <p>The main thread becomes blocked until the computation completes. During this time:</p>
                <ul>
                    <li>The UI becomes <strong>completely unresponsive</strong></li>
                    <li>User clicks and other inputs are <strong>delayed</strong></li>
                    <li>Animations and updates <strong>freeze</strong></li>
                    <li>The browser might show a "page unresponsive" warning</li>
                </ul>
                
                <p>This creates a poor user experience, making your application feel slow and unresponsive even if the computation itself is necessary.</p>
                
                <div class="thread-diagram">
                    <div class="thread main-thread">
                        <div class="thread-title">Main Thread (Single-Threaded Approach)</div>
                        <div class="thread-task ui-task">Handle UI Events</div>
                        <div class="thread-task computation-task">Run Heavy Computation (BLOCKS THREAD)</div>
                        <div class="thread-task ui-task">Update DOM (BLOCKED)</div>
                        <div class="thread-task ui-task">Handle More UI Events (BLOCKED)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="solution-section" class="content-section">
            <div class="explanation-content">
                <h2>The Solution: Web Workers</h2>
                <p>Web Workers provide a way to run JavaScript in background threads, separate from the main thread. This allows you to perform heavy computations without blocking the UI.</p>
                
                <h3>How Web Workers Help:</h3>
                <ul>
                    <li>They run in a separate thread parallel to the main thread</li>
                    <li>The UI remains responsive during computation</li>
                    <li>Better utilization of multi-core processors</li>
                    <li>Improved user experience with smooth interactions</li>
                </ul>
                
                <div class="thread-diagram">
                    <div class="thread main-thread">
                        <div class="thread-title">Main Thread</div>
                        <div class="thread-task ui-task">Handle UI Events</div>
                        <div class="thread-task ui-task">Create Worker</div>
                        <div class="thread-task ui-task">Continue Handling UI (NOT BLOCKED)</div>
                        <div class="thread-task ui-task">Receive Result</div>
                    </div>
                    <div class="thread-arrow">→</div>
                    <div class="thread worker-thread">
                        <div class="thread-title">Worker Thread</div>
                        <div class="thread-task worker-task">Initialize</div>
                        <div class="thread-task worker-task">Receive Task</div>
                        <div class="thread-task worker-task">Run Heavy Computation</div>
                        <div class="thread-task worker-task">Send Result Back</div>
                    </div>
                </div>
                
                <h3>Web Worker Implementation:</h3>
                
                <div class="code-container">
                    <div class="code">// Main script (main.js)
const worker = new Worker('worker.js');

// Start the heavy calculation in the worker
worker.postMessage({ action: 'start', iterations: 1e7 });

// The UI remains responsive while the worker computes

// Handle the result when the worker finishes
worker.onmessage = function(e) {
    console.log('Computation complete:', e.data.result);
    // Update UI with result
};</div>
                </div>
                
                <div class="code-container">
                    <div class="code">// Worker script (worker.js)
self.onmessage = function(e) {
    if (e.data.action === 'start') {
        const iterations = e.data.iterations;
        let result = 0;
        
        // Perform heavy computation
        for (let i = 0; i < iterations; i++) {
            // Example calculation
            result += Math.sqrt(i);
        }
        
        // Send the result back to the main thread
        self.postMessage({ result: result });
    }
};</div>
                </div>
                
                <h3>Web Worker Limitations:</h3>
                <ul>
                    <li>Cannot directly access the DOM</li>
                    <li>Cannot use some browser APIs (like window or document)</li>
                    <li>Communication with the main thread has overhead</li>
                    <li>Limited browser support in older browsers</li>
                </ul>
                
                <h3>When to Use Web Workers:</h3>
                <ul>
                    <li>Data processing (sorting large arrays, filtering, etc.)</li>
                    <li>Complex calculations and algorithms</li>
                    <li>Image or video processing</li>
                    <li>Parsing large data files (CSV, JSON, etc.)</li>
                    <li>Long-running tasks that don't need DOM access</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Simulation state
        let simulation = {
            running: false,
            mainThreadTasks: 0,
            workerThreadTasks: 0,
            mainResponsiveness: 100,
            workerResponsiveness: 100
        };
        
        // Switch between tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`${tab}-section`).classList.add('active');
        }
        
        // Animate button click
        function animateClick(element) {
            gsap.to(element, {
                backgroundColor: "#2980b9",
                scale: 0.95,
                duration: 0.1,
                yoyo: true,
                repeat: 1,
                onComplete: () => {
                    element.style.backgroundColor = "";
                    element.style.transform = "";
                }
            });
        }
        
        // Start only the main thread computation
        function startMainThreadComputation() {
            if (simulation.running) return;
            simulation.running = true;
            
            // Disable start buttons - using querySelector to prevent null errors
            const mainBtn = document.querySelector('#main-start-btn');
            const workerBtn = document.querySelector('#worker-start-btn');
            if (mainBtn) mainBtn.disabled = true;
            if (workerBtn) workerBtn.disabled = true;
            
            // Run main thread computation (blocking)
            runMainThreadComputation();
        }
        
        // Start only the worker thread computation
        function startWorkerComputation() {
            if (simulation.running) return;
            simulation.running = true;
            
            // Disable start buttons - using querySelector to prevent null errors
            const mainBtn = document.querySelector('#main-start-btn');
            const workerBtn = document.querySelector('#worker-start-btn');
            if (mainBtn) mainBtn.disabled = true;
            if (workerBtn) workerBtn.disabled = true;
            
            // Run worker thread computation (non-blocking)
            runWorkerThreadComputation();
        }
        
        // Legacy function for backward compatibility
        function startSimulation() {
            startMainThreadComputation();
            startWorkerComputation();
        }
        
        // Run actual heavy computation on main thread
        function runMainThreadComputation() {
            const computationBox = document.getElementById('main-computation-box');
            const loadingBar = document.getElementById('main-loading-bar');
            const overlay = document.getElementById('main-overlay');
            
            // Show computation indicator
            computationBox.style.display = 'flex';
            
            // Show UI blocked overlay
            gsap.to(overlay, { opacity: 0.9, duration: 0.5 });
            
            // Update UI to show blocked state
            simulation.mainResponsiveness = 0;
            document.getElementById('main-responsiveness').textContent = '0% (BLOCKED)';
            
            // Run an actual heavy computation to block the main thread
            // This will freeze the UI for several seconds
            const startTime = performance.now();
            
            // Significantly increase iterations to ensure a longer blocking period
            const iterations = 2000000000; // 2 billion iterations
            let result = 0;
            
            // Add extra complexity to each iteration to make it more CPU intensive
            for (let i = 0; i < iterations; i++) {
                // Heavier calculation with multiple operations
                result += Math.sqrt(i * 0.01) + Math.sin(i * 0.001) + Math.cos(i * 0.002);
                
                // Less frequent UI updates to make blocking more noticeable
                if (i % (iterations/10) === 0) {
                    const progress = Math.floor(i / iterations * 100);
                    try {
                        loadingBar.style.width = `${progress}%`;
                    } catch (e) {
                        // Handle any errors if the UI update fails
                    }
                }
            }
            
            // Computation finished
            const endTime = performance.now();
            console.log(`Main thread computation took ${(endTime - startTime)/1000} seconds`);
            
            computationBox.style.display = 'none';
            gsap.to(overlay, { opacity: 0, duration: 0.5 });
            simulation.mainThreadTasks++;
            document.getElementById('main-tasks').textContent = simulation.mainThreadTasks;
            simulation.mainResponsiveness = 100;
            document.getElementById('main-responsiveness').textContent = '100%';
            document.getElementById('start-btn').disabled = false;
        }
        
        // Simulate web worker computation with proper error handling
        function runWorkerThreadComputation() {
            // Safely get elements
            const computationBox = document.querySelector('#worker-computation-box');
            const loadingBar = document.querySelector('#worker-loading-bar');
            const workerResponsiveness = document.querySelector('#worker-responsiveness');
            const workerTasks = document.querySelector('#worker-tasks');
            const workerStartBtn = document.querySelector('#worker-start-btn');
            
            // Show computation indicator
            if (computationBox) computationBox.style.display = 'flex';
            
            // Update metrics to show UI is still responsive
            if (workerResponsiveness) workerResponsiveness.textContent = '100% (RESPONSIVE)';
            
            // Since we can't create an actual Web Worker in this demo (browser security restrictions),
            // we'll simulate it using setTimeout to keep the UI responsive
            let progress = 0;
            
            function simulateWorkerProgress() {
                // Update progress every 50ms to simulate worker sending messages back
                progress += 1;
                if (loadingBar) loadingBar.style.width = `${progress}%`;
                
                if (progress < 100) {
                    // Continue updating without blocking the main thread
                    setTimeout(simulateWorkerProgress, 50);
                } else {
                    // Simulation completed
                    setTimeout(() => {
                        if (computationBox) computationBox.style.display = 'none';
                        simulation.workerThreadTasks++;
                        if (workerTasks) workerTasks.textContent = simulation.workerThreadTasks;
                        
                        // Re-enable buttons
                        const mainBtn = document.querySelector('#main-start-btn');
                        const workerBtn = document.querySelector('#worker-start-btn');
                        try {
                            if (mainBtn) mainBtn.disabled = false;
                            if (workerBtn) workerBtn.disabled = false;
                        } catch (e) {
                            console.error("Error re-enabling buttons:", e);
                        }
                        
                        simulation.running = false;
                    }, 500);
                }
            }
            
            // Start the simulated worker
            setTimeout(simulateWorkerProgress, 100);
        }
        
        // Test UI interactivity during computation
        function testInteraction() {
            // Bounce all UI elements to test responsiveness
            const mainUIElements = document.querySelectorAll('#main-thread-content .ui-element');
            const workerUIElements = document.querySelectorAll('#worker-thread-content .ui-element');
            
            // Animate main thread UI elements (will be blocked if computation is running)
            mainUIElements.forEach((element, index) => {
                gsap.to(element, {
                    y: -10,
                    duration: 0.2,
                    delay: index * 0.1,
                    yoyo: true,
                    repeat: 1,
                    onComplete: () => {
                        element.style.transform = "";
                    }
                });
            });
            
            // Animate worker thread UI elements (should stay responsive)
            workerUIElements.forEach((element, index) => {
                gsap.to(element, {
                    y: -10,
                    duration: 0.2,
                    delay: index * 0.1,
                    yoyo: true,
                    repeat: 1,
                    onComplete: () => {
                        element.style.transform = "";
                    }
                });
            });
        }
        
        // Reset the simulation
        function resetSimulation() {
            // Kill any running GSAP animations
            gsap.killTweensOf(".ui-element");
            
            // Safely reset UI elements using querySelector to prevent null errors
            const mainCompBox = document.querySelector('#main-computation-box');
            const workerCompBox = document.querySelector('#worker-computation-box');
            const mainLoadingBar = document.querySelector('#main-loading-bar');
            const workerLoadingBar = document.querySelector('#worker-loading-bar');
            const mainOverlay = document.querySelector('#main-overlay');
            
            if (mainCompBox) mainCompBox.style.display = 'none';
            if (workerCompBox) workerCompBox.style.display = 'none';
            if (mainLoadingBar) mainLoadingBar.style.width = '0%';
            if (workerLoadingBar) workerLoadingBar.style.width = '0%';
            if (mainOverlay) mainOverlay.style.opacity = '0';
            
            // Reset metrics
            simulation.running = false;
            simulation.mainThreadTasks = 0;
            simulation.workerThreadTasks = 0;
            simulation.mainResponsiveness = 100;
            simulation.workerResponsiveness = 100;
            
            // Safely update display metrics
            const mainResp = document.querySelector('#main-responsiveness');
            const workerResp = document.querySelector('#worker-responsiveness');
            const mainTasks = document.querySelector('#main-tasks');
            const workerTasks = document.querySelector('#worker-tasks');
            
            if (mainResp) mainResp.textContent = '100%';
            if (workerResp) workerResp.textContent = '100%';
            if (mainTasks) mainTasks.textContent = '0';
            if (workerTasks) workerTasks.textContent = '0';
            
            // Enable start buttons
            const mainBtn = document.querySelector('#main-start-btn');
            const workerBtn = document.querySelector('#worker-start-btn');
            if (mainBtn) mainBtn.disabled = false;
            if (workerBtn) workerBtn.disabled = false;
        }
    </script>
</body>
</html>